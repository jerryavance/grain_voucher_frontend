"use strict";(self.webpackChunkgrain_voucher_system=self.webpackChunkgrain_voucher_system||[]).push([[1220],{11220:(e,r,n)=>{n.r(r),n.d(r,{default:()=>Ne});var i=n(89379),t=n(80045),s=n(65043),a=n(73216),l=n(96446),o=n(26240),d=n(79285),c=n(85865),h=n(67024),u=n(8302),x=n(43845),m=n(77739),g=n(17392),A=n(67254),v=n(12110),j=n(26494),_=n(63336),y=n(14912),b=n(24056),p=n(68903),f=n(79650),C=n(71806),k=n(84882),w=n(28076),S=n(10039),W=n(73460),I=n(87332),q=n(16056),D=n(83560),T=n(71403),B=n(70141),R=n(51387),F=n(23768),N=n(10183),V=n(76839),z=n(25078),P=n(12299),L=n(70579);const G=["draft","pending_approval","approved","pending_allocation","ready_for_delivery","in_transit","delivered","completed"],O={draft:"Draft",pending_approval:"Pending Approval",approved:"Approved",pending_allocation:"Pending Allocation",ready_for_delivery:"Ready for Delivery",in_transit:"In Transit",delivered:"Delivered",completed:"Completed"},M=["pending_allocation"],Y=e=>{let{currentStatus:r}=e;if("cancelled"===r||"rejected"===r)return(0,L.jsx)(l.A,{sx:{textAlign:"center",py:2},children:(0,L.jsx)(x.A,{label:"cancelled"===r?"Trade Cancelled":"Trade Rejected",color:"error",sx:{fontSize:16,py:2,px:3}})});const n=G.indexOf(r);return(0,L.jsx)(l.A,{sx:{width:"100%"},children:(0,L.jsx)(V.A,{activeStep:n,alternativeLabel:!0,children:G.map((e=>(0,L.jsx)(z.A,{children:(0,L.jsx)(P.A,{optional:M.includes(e)?(0,L.jsx)(l.A,{component:"span",sx:{fontSize:10,color:"text.secondary"},children:"(If required)"}):void 0,children:O[e]})},e)))})})};var U=n(39336),E=n(23722);const Q=e=>{let{tradeId:r}=e;const[n,i]=(0,s.useState)(null),[t,a]=(0,s.useState)(!0);(0,s.useEffect)((()=>{o()}),[r]);const o=async()=>{try{a(!0);const e=await N.O.getCostBreakdown(r);i(e),a(!1)}catch(e){a(!1),console.error("Failed to load cost breakdown")}};if(t)return(0,L.jsx)(l.A,{display:"flex",justifyContent:"center",p:3,children:(0,L.jsx)(E.A,{})});if(!n)return(0,L.jsx)(c.A,{children:"No cost breakdown available"});const d=e=>new Intl.NumberFormat("en-UG",{style:"currency",currency:"UGX",minimumFractionDigits:0}).format(e);return(0,L.jsx)(l.A,{children:(0,L.jsxs)(p.Ay,{container:!0,spacing:3,children:[(0,L.jsx)(p.Ay,{item:!0,xs:12,md:6,children:(0,L.jsxs)(_.A,{sx:{p:2},children:[(0,L.jsx)(c.A,{variant:"h6",gutterBottom:!0,children:"Direct Costs"}),(0,L.jsx)(C.A,{size:"small",children:(0,L.jsxs)(W.A,{children:[(0,L.jsxs)(w.A,{children:[(0,L.jsx)(S.A,{children:"Purchase Cost"}),(0,L.jsx)(S.A,{align:"right",children:d(n.purchase_cost)})]}),(0,L.jsxs)(w.A,{children:[(0,L.jsx)(S.A,{children:"Aflatoxin/QA Cost"}),(0,L.jsx)(S.A,{align:"right",children:d(n.aflatoxin_qa_cost)})]}),(0,L.jsxs)(w.A,{children:[(0,L.jsx)(S.A,{children:"Weighbridge Cost"}),(0,L.jsx)(S.A,{align:"right",children:d(n.weighbridge_cost)})]}),(0,L.jsxs)(w.A,{children:[(0,L.jsx)(S.A,{children:"Offloading Cost"}),(0,L.jsx)(S.A,{align:"right",children:d(n.offloading_cost)})]}),(0,L.jsxs)(w.A,{children:[(0,L.jsx)(S.A,{children:"Loading Cost"}),(0,L.jsx)(S.A,{align:"right",children:d(n.loading_cost)})]}),(0,L.jsxs)(w.A,{children:[(0,L.jsx)(S.A,{children:"Transport Cost"}),(0,L.jsx)(S.A,{align:"right",children:d(n.transport_cost)})]})]})})]})}),(0,L.jsx)(p.Ay,{item:!0,xs:12,md:6,children:(0,L.jsxs)(_.A,{sx:{p:2},children:[(0,L.jsx)(c.A,{variant:"h6",gutterBottom:!0,children:"Additional Costs"}),(0,L.jsx)(C.A,{size:"small",children:(0,L.jsxs)(W.A,{children:[(0,L.jsxs)(w.A,{children:[(0,L.jsx)(S.A,{children:"Financing Cost"}),(0,L.jsx)(S.A,{align:"right",children:d(n.financing_cost)})]}),(0,L.jsxs)(w.A,{children:[(0,L.jsx)(S.A,{children:"GIT Insurance"}),(0,L.jsx)(S.A,{align:"right",children:d(n.git_insurance_cost)})]}),(0,L.jsxs)(w.A,{children:[(0,L.jsx)(S.A,{children:"Deductions"}),(0,L.jsx)(S.A,{align:"right",children:d(n.deduction_cost)})]}),(0,L.jsxs)(w.A,{children:[(0,L.jsx)(S.A,{children:"Other Expenses"}),(0,L.jsx)(S.A,{align:"right",children:d(n.other_expenses)})]}),(0,L.jsxs)(w.A,{children:[(0,L.jsx)(S.A,{children:"Bennu Fees (to seller)"}),(0,L.jsx)(S.A,{align:"right",children:d(n.bennu_to_seller)})]}),n.loss_cost>0&&(0,L.jsxs)(w.A,{children:[(0,L.jsx)(S.A,{children:"Loss Cost"}),(0,L.jsx)(S.A,{align:"right",sx:{color:"error.main"},children:d(n.loss_cost)})]})]})})]})}),(0,L.jsx)(p.Ay,{item:!0,xs:12,children:(0,L.jsxs)(_.A,{sx:{p:2},children:[(0,L.jsx)(c.A,{variant:"h6",gutterBottom:!0,children:"Summary"}),(0,L.jsx)(U.A,{sx:{my:1}}),(0,L.jsxs)(p.Ay,{container:!0,spacing:2,children:[(0,L.jsxs)(p.Ay,{item:!0,xs:6,children:[(0,L.jsx)(c.A,{variant:"body2",color:"text.secondary",children:"Total Trade Cost"}),(0,L.jsx)(c.A,{variant:"h6",fontWeight:700,children:d(n.total_trade_cost)})]}),(0,L.jsxs)(p.Ay,{item:!0,xs:6,children:[(0,L.jsx)(c.A,{variant:"body2",color:"text.secondary",children:"Payable by Buyer"}),(0,L.jsx)(c.A,{variant:"h6",fontWeight:700,color:"success.main",children:d(n.payable_by_buyer)})]}),(0,L.jsxs)(p.Ay,{item:!0,xs:6,children:[(0,L.jsx)(c.A,{variant:"body2",color:"text.secondary",children:"Gross Margin"}),(0,L.jsx)(c.A,{variant:"h6",fontWeight:700,color:"primary.main",children:d(n.margin)})]}),(0,L.jsxs)(p.Ay,{item:!0,xs:6,children:[(0,L.jsx)(c.A,{variant:"body2",color:"text.secondary",children:"Net Profit (after brokerage)"}),(0,L.jsx)(c.A,{variant:"h6",fontWeight:700,color:"primary.main",children:d(n.net_profit)})]})]})]})}),n.brokerage_costs&&n.brokerage_costs.length>0&&(0,L.jsx)(p.Ay,{item:!0,xs:12,children:(0,L.jsxs)(_.A,{sx:{p:2},children:[(0,L.jsx)(c.A,{variant:"h6",gutterBottom:!0,children:"Brokerage Costs"}),(0,L.jsxs)(C.A,{size:"small",children:[(0,L.jsx)(k.A,{children:(0,L.jsxs)(w.A,{children:[(0,L.jsx)(S.A,{children:"Agent"}),(0,L.jsx)(S.A,{children:"Type"}),(0,L.jsx)(S.A,{children:"Value"}),(0,L.jsx)(S.A,{align:"right",children:"Amount"})]})}),(0,L.jsx)(W.A,{children:n.brokerage_costs.map(((e,r)=>(0,L.jsxs)(w.A,{children:[(0,L.jsx)(S.A,{children:e.agent||"N/A"}),(0,L.jsx)(S.A,{children:e.commission_type}),(0,L.jsx)(S.A,{children:e.commission_value}),(0,L.jsx)(S.A,{align:"right",children:d(e.amount)})]},r)))})]})]})})]})})};var X=n(90035),Z=n(4219),K=n(35316),H=n(67784),J=n(32143),$=n(74605),ee=n(51962),re=n(29347),ne=n(81637),ie=n(63516),te=n(73033);const se=te.Ik({cost_type:te.Yj().required("Cost type is required"),amount:te.ai().required("Amount is required").min(0,"Amount must be positive"),description:te.Yj(),is_per_unit:te.zM()}),ae=["Storage","Handling","Fumigation","Packaging","Administrative","Insurance","Security","Other"],le=e=>{let{open:r,onClose:n,tradeId:t,onSuccess:a,initialValues:l}=e;const[o,d]=(0,s.useState)(!1),c=(0,ie.Wx)({initialValues:l||{cost_type:"",amount:"",description:"",is_per_unit:!1},validationSchema:se,enableReinitialize:!0,onSubmit:async e=>{try{d(!0);const r=(0,i.A)((0,i.A)({},e),{},{trade:t});null!==l&&void 0!==l&&l.id?(await N.O.updateTradeCost(r,l.id),F.oR.success("Cost updated successfully")):(await N.O.createTradeCost(r),F.oR.success("Cost added successfully")),a(),n(),c.resetForm()}catch(o){var r,s;F.oR.error((null===o||void 0===o||null===(r=o.response)||void 0===r||null===(s=r.data)||void 0===s?void 0:s.error)||"Failed to save cost")}finally{d(!1)}}}),h=()=>{o||(c.resetForm(),n())};return(0,L.jsxs)(X.A,{open:r,onClose:h,maxWidth:"sm",fullWidth:!0,children:[(0,L.jsx)(Z.A,{children:l?"Edit Trade Cost":"Add Trade Cost"}),(0,L.jsxs)("form",{onSubmit:c.handleSubmit,children:[(0,L.jsx)(K.A,{children:(0,L.jsxs)(p.Ay,{container:!0,spacing:2,children:[(0,L.jsx)(p.Ay,{item:!0,xs:12,children:(0,L.jsx)(H.A,{select:!0,fullWidth:!0,label:"Cost Type *",name:"cost_type",value:c.values.cost_type,onChange:c.handleChange,error:c.touched.cost_type&&Boolean(c.errors.cost_type),helperText:c.touched.cost_type&&c.errors.cost_type,children:ae.map((e=>(0,L.jsx)(J.A,{value:e,children:e},e)))})}),(0,L.jsx)(p.Ay,{item:!0,xs:12,children:(0,L.jsx)(H.A,{fullWidth:!0,type:"number",label:"Amount *",name:"amount",value:c.values.amount,onChange:c.handleChange,error:c.touched.amount&&Boolean(c.errors.amount),helperText:c.touched.amount&&c.errors.amount,InputProps:{startAdornment:"UGX"}})}),(0,L.jsx)(p.Ay,{item:!0,xs:12,children:(0,L.jsx)($.A,{control:(0,L.jsx)(ee.A,{name:"is_per_unit",checked:c.values.is_per_unit,onChange:c.handleChange}),label:"Is Per Unit (per kg)"})}),(0,L.jsx)(p.Ay,{item:!0,xs:12,children:(0,L.jsx)(H.A,{fullWidth:!0,multiline:!0,rows:3,label:"Description",name:"description",value:c.values.description,onChange:c.handleChange,error:c.touched.description&&Boolean(c.errors.description),helperText:c.touched.description&&c.errors.description})})]})}),(0,L.jsxs)(re.A,{children:[(0,L.jsx)(u.A,{onClick:h,disabled:o,children:"Cancel"}),(0,L.jsx)(u.A,{type:"submit",variant:"contained",disabled:o,children:o?(0,L.jsx)(ne.A,{size:24}):l?"Update":"Add"})]})]})]})};var oe=n(35705);const de=te.Ik({agent_id:te.Yj().required("Agent is required"),commission_type:te.Yj().required("Commission type is required"),commission_value:te.ai().required("Commission value is required").min(0,"Must be positive"),notes:te.Yj()}),ce=[{value:"percentage",label:"Percentage of Trade Value"},{value:"per_mt",label:"Per Metric Ton"},{value:"per_kg",label:"Per Kilogram"},{value:"fixed",label:"Fixed Amount"}],he=e=>{let{open:r,onClose:n,tradeId:t,onSuccess:a,initialValues:l}=e;const[o,d]=(0,s.useState)(!1),[c,h]=(0,s.useState)([]),[x,m]=(0,s.useState)(!1);(0,s.useEffect)((()=>{r&&g()}),[r]);const g=async e=>{try{m(!0);const r=await N.O.getAgents(e);h(r.results.map((e=>({label:"".concat(e.first_name," ").concat(e.last_name),value:e.id}))))}catch(r){console.error("Failed to load agents:",r)}finally{m(!1)}},A=(0,ie.Wx)({initialValues:l||{agent_id:"",commission_type:"percentage",commission_value:"",notes:""},validationSchema:de,enableReinitialize:!0,onSubmit:async e=>{try{d(!0);const r=(0,i.A)((0,i.A)({},e),{},{trade:t});null!==l&&void 0!==l&&l.id?(await N.O.updateBrokerage(r,l.id),F.oR.success("Brokerage updated successfully")):(await N.O.createBrokerage(r),F.oR.success("Brokerage added successfully")),a(),n(),A.resetForm()}catch(o){var r,s;F.oR.error((null===o||void 0===o||null===(r=o.response)||void 0===r||null===(s=r.data)||void 0===s?void 0:s.error)||"Failed to save brokerage")}finally{d(!1)}}}),v=()=>{o||(A.resetForm(),n())};return(0,L.jsxs)(X.A,{open:r,onClose:v,maxWidth:"sm",fullWidth:!0,children:[(0,L.jsx)(Z.A,{children:l?"Edit Brokerage":"Add Brokerage"}),(0,L.jsxs)("form",{onSubmit:A.handleSubmit,children:[(0,L.jsx)(K.A,{children:(0,L.jsxs)(p.Ay,{container:!0,spacing:2,children:[(0,L.jsx)(p.Ay,{item:!0,xs:12,children:(0,L.jsx)(oe.A,{options:c,loading:x,value:c.find((e=>e.value===A.values.agent_id))||null,onChange:(e,r)=>{A.setFieldValue("agent_id",(null===r||void 0===r?void 0:r.value)||"")},onInputChange:(e,r)=>{r&&g(r)},renderInput:e=>(0,L.jsx)(H.A,(0,i.A)((0,i.A)({},e),{},{label:"Agent/BDM *",error:A.touched.agent_id&&Boolean(A.errors.agent_id),helperText:A.touched.agent_id&&A.errors.agent_id}))})}),(0,L.jsx)(p.Ay,{item:!0,xs:12,children:(0,L.jsx)(H.A,{select:!0,fullWidth:!0,label:"Commission Type *",name:"commission_type",value:A.values.commission_type,onChange:A.handleChange,error:A.touched.commission_type&&Boolean(A.errors.commission_type),helperText:A.touched.commission_type&&A.errors.commission_type,children:ce.map((e=>(0,L.jsx)(J.A,{value:e.value,children:e.label},e.value)))})}),(0,L.jsx)(p.Ay,{item:!0,xs:12,children:(0,L.jsx)(H.A,{fullWidth:!0,type:"number",label:"Commission Value *",name:"commission_value",value:A.values.commission_value,onChange:A.handleChange,error:A.touched.commission_value&&Boolean(A.errors.commission_value),helperText:A.touched.commission_value&&A.errors.commission_value,placeholder:"percentage"===A.values.commission_type?"Enter percentage (e.g., 2.5)":"Enter amount"})}),(0,L.jsx)(p.Ay,{item:!0,xs:12,children:(0,L.jsx)(H.A,{fullWidth:!0,multiline:!0,rows:3,label:"Notes",name:"notes",value:A.values.notes,onChange:A.handleChange})})]})}),(0,L.jsxs)(re.A,{children:[(0,L.jsx)(u.A,{onClick:v,disabled:o,children:"Cancel"}),(0,L.jsx)(u.A,{type:"submit",variant:"contained",disabled:o,children:o?(0,L.jsx)(ne.A,{size:24}):l?"Update":"Add"})]})]})]})},ue=te.Ik({investor_account_id:te.Yj().required("Investor account is required"),allocated_amount:te.ai().required("Allocated amount is required").min(0,"Must be positive"),notes:te.Yj()}),xe=e=>{let{open:r,onClose:n,tradeId:t,onSuccess:a,tradeDetails:l}=e;const[o,d]=(0,s.useState)(!1),[h,x]=(0,s.useState)([]),[m,g]=(0,s.useState)(!1);(0,s.useEffect)((()=>{r&&v()}),[r]);const v=async e=>{try{g(!0);const r=await N.O.getInvestorAccounts(e);x(r.results.map((e=>({label:"".concat(e.investor_name," - Available: ").concat(y(e.available_balance)),value:e.id,available_balance:e.available_balance}))))}catch(r){console.error("Failed to load investors:",r)}finally{g(!1)}},j=(0,ie.Wx)({initialValues:{investor_account_id:"",allocated_amount:"",notes:""},validationSchema:ue,onSubmit:async e=>{try{d(!0);const r=(0,i.A)((0,i.A)({},e),{},{trade:t});await N.O.createFinancingAllocation(r),F.oR.success("Financing allocated successfully"),a(),n(),j.resetForm()}catch(h){var r,s,l,o,c;F.oR.error((null===h||void 0===h||null===(r=h.response)||void 0===r||null===(s=r.data)||void 0===s||null===(l=s.allocated_amount)||void 0===l?void 0:l[0])||(null===h||void 0===h||null===(o=h.response)||void 0===o||null===(c=o.data)||void 0===c?void 0:c.error)||"Failed to allocate financing")}finally{d(!1)}}}),_=()=>{o||(j.resetForm(),n())},y=e=>new Intl.NumberFormat("en-UG",{style:"currency",currency:"UGX",minimumFractionDigits:0}).format(e);return(0,L.jsxs)(X.A,{open:r,onClose:_,maxWidth:"sm",fullWidth:!0,children:[(0,L.jsx)(Z.A,{children:"Allocate Investor Financing"}),(0,L.jsxs)("form",{onSubmit:j.handleSubmit,children:[(0,L.jsxs)(K.A,{children:[l&&(0,L.jsxs)(A.A,{severity:"info",sx:{mb:2},children:[(0,L.jsxs)(c.A,{variant:"body2",children:["Trade Cost: ",y(l.total_trade_cost||0)]}),(0,L.jsxs)(c.A,{variant:"body2",children:["Already Financed:"," ",y(l.total_financing_allocated||0)]}),(0,L.jsxs)(c.A,{variant:"body2",fontWeight:600,children:["Remaining:"," ",y((l.total_trade_cost||0)-(l.total_financing_allocated||0))]})]}),(0,L.jsxs)(p.Ay,{container:!0,spacing:2,children:[(0,L.jsx)(p.Ay,{item:!0,xs:12,children:(0,L.jsx)(oe.A,{options:h,loading:m,value:h.find((e=>e.value===j.values.investor_account_id))||null,onChange:(e,r)=>{j.setFieldValue("investor_account_id",(null===r||void 0===r?void 0:r.value)||"")},onInputChange:(e,r)=>{r&&v(r)},renderInput:e=>(0,L.jsx)(H.A,(0,i.A)((0,i.A)({},e),{},{label:"Investor Account *",error:j.touched.investor_account_id&&Boolean(j.errors.investor_account_id),helperText:j.touched.investor_account_id&&j.errors.investor_account_id}))})}),(0,L.jsx)(p.Ay,{item:!0,xs:12,children:(0,L.jsx)(H.A,{fullWidth:!0,type:"number",label:"Allocated Amount *",name:"allocated_amount",value:j.values.allocated_amount,onChange:j.handleChange,error:j.touched.allocated_amount&&Boolean(j.errors.allocated_amount),helperText:j.touched.allocated_amount&&j.errors.allocated_amount,InputProps:{startAdornment:"UGX"}})}),(0,L.jsx)(p.Ay,{item:!0,xs:12,children:(0,L.jsx)(H.A,{fullWidth:!0,multiline:!0,rows:3,label:"Notes",name:"notes",value:j.values.notes,onChange:j.handleChange})})]})]}),(0,L.jsxs)(re.A,{children:[(0,L.jsx)(u.A,{onClick:_,disabled:o,children:"Cancel"}),(0,L.jsx)(u.A,{type:"submit",variant:"contained",disabled:o,children:o?(0,L.jsx)(ne.A,{size:24}):"Allocate"})]})]})]})},me=te.Ik({investor_account_id:te.Yj().required("Investor account is required"),amount:te.ai().required("Amount is required").min(0,"Must be positive"),interest_rate:te.ai().required("Interest rate is required").min(0,"Must be positive").max(100,"Cannot exceed 100%"),due_date:te.p6().required("Due date is required"),notes:te.Yj()}),ge=e=>{let{open:r,onClose:n,tradeId:t,onSuccess:a}=e;const[l,o]=(0,s.useState)(!1),[d,h]=(0,s.useState)([]),[x,m]=(0,s.useState)(!1);(0,s.useEffect)((()=>{r&&g()}),[r]);const g=async e=>{try{m(!0);const r=await N.O.getInvestorAccounts(e);h(r.results.map((e=>({label:"".concat(e.investor_name," - Available: ").concat(_(e.available_balance)),value:e.id,available_balance:e.available_balance}))))}catch(r){console.error("Failed to load investors:",r)}finally{m(!1)}},v=(0,ie.Wx)({initialValues:{investor_account_id:"",amount:"",interest_rate:"",due_date:"",notes:""},validationSchema:me,onSubmit:async e=>{try{o(!0);const r=(0,i.A)((0,i.A)({},e),{},{trade:t});await N.O.createLoan(r),F.oR.success("Loan created successfully"),a(),n(),v.resetForm()}catch(h){var r,s,l,d,c;F.oR.error((null===h||void 0===h||null===(r=h.response)||void 0===r||null===(s=r.data)||void 0===s||null===(l=s.amount)||void 0===l?void 0:l[0])||(null===h||void 0===h||null===(d=h.response)||void 0===d||null===(c=d.data)||void 0===c?void 0:c.error)||"Failed to create loan")}finally{o(!1)}}}),j=()=>{l||(v.resetForm(),n())},_=e=>new Intl.NumberFormat("en-UG",{style:"currency",currency:"UGX",minimumFractionDigits:0}).format(e),y=(()=>{const e=parseFloat(v.values.amount)||0,r=parseFloat(v.values.interest_rate)||0,n=new Date(v.values.due_date),i=new Date,t=Math.max(0,Math.ceil((n.getTime()-i.getTime())/864e5)),s=e*(r/100)*t/365;return{interest:s,total:e+s,days:t}})();return(0,L.jsxs)(X.A,{open:r,onClose:j,maxWidth:"sm",fullWidth:!0,children:[(0,L.jsx)(Z.A,{children:"Create Trade Loan"}),(0,L.jsxs)("form",{onSubmit:v.handleSubmit,children:[(0,L.jsx)(K.A,{children:(0,L.jsxs)(p.Ay,{container:!0,spacing:2,children:[(0,L.jsx)(p.Ay,{item:!0,xs:12,children:(0,L.jsx)(oe.A,{options:d,loading:x,value:d.find((e=>e.value===v.values.investor_account_id))||null,onChange:(e,r)=>{v.setFieldValue("investor_account_id",(null===r||void 0===r?void 0:r.value)||"")},onInputChange:(e,r)=>{r&&g(r)},renderInput:e=>(0,L.jsx)(H.A,(0,i.A)((0,i.A)({},e),{},{label:"Investor Account *",error:v.touched.investor_account_id&&Boolean(v.errors.investor_account_id),helperText:v.touched.investor_account_id&&v.errors.investor_account_id}))})}),(0,L.jsx)(p.Ay,{item:!0,xs:12,sm:6,children:(0,L.jsx)(H.A,{fullWidth:!0,type:"number",label:"Loan Amount *",name:"amount",value:v.values.amount,onChange:v.handleChange,error:v.touched.amount&&Boolean(v.errors.amount),helperText:v.touched.amount&&v.errors.amount,InputProps:{startAdornment:"UGX"}})}),(0,L.jsx)(p.Ay,{item:!0,xs:12,sm:6,children:(0,L.jsx)(H.A,{fullWidth:!0,type:"number",label:"Interest Rate (% p.a.) *",name:"interest_rate",value:v.values.interest_rate,onChange:v.handleChange,error:v.touched.interest_rate&&Boolean(v.errors.interest_rate),helperText:v.touched.interest_rate&&v.errors.interest_rate,InputProps:{endAdornment:"%"}})}),(0,L.jsx)(p.Ay,{item:!0,xs:12,children:(0,L.jsx)(H.A,{fullWidth:!0,type:"date",label:"Due Date *",name:"due_date",value:v.values.due_date,onChange:v.handleChange,error:v.touched.due_date&&Boolean(v.errors.due_date),helperText:v.touched.due_date&&v.errors.due_date,InputLabelProps:{shrink:!0},inputProps:{min:(new Date).toISOString().split("T")[0]}})}),v.values.amount&&v.values.interest_rate&&v.values.due_date&&(0,L.jsx)(p.Ay,{item:!0,xs:12,children:(0,L.jsxs)(A.A,{severity:"info",children:[(0,L.jsxs)(c.A,{variant:"body2",children:["Loan Period: ",y.days," days"]}),(0,L.jsxs)(c.A,{variant:"body2",children:["Estimated Interest: ",_(y.interest)]}),(0,L.jsxs)(c.A,{variant:"body2",fontWeight:600,children:["Total Due: ",_(y.total)]})]})}),(0,L.jsx)(p.Ay,{item:!0,xs:12,children:(0,L.jsx)(H.A,{fullWidth:!0,multiline:!0,rows:3,label:"Notes",name:"notes",value:v.values.notes,onChange:v.handleChange})})]})}),(0,L.jsxs)(re.A,{children:[(0,L.jsx)(u.A,{onClick:j,disabled:l,children:"Cancel"}),(0,L.jsx)(u.A,{type:"submit",variant:"contained",disabled:l,children:l?(0,L.jsx)(ne.A,{size:24}):"Create Loan"})]})]})]})};var Ae=n(13194),ve=n(62071),je=n(10611),_e=n(98606),ye=n(31795);const be=e=>{let{deliverySummary:r,onCreateDelivery:n}=e;if(!r)return null;const{total_ordered_kg:i,total_delivered_kg:t,remaining_kg:s,completion_percentage:a,is_fully_delivered:o,delivery_count:d,can_create_more_deliveries:m}=r;return(0,L.jsx)(v.A,{sx:{mb:3,borderRadius:2,border:1,borderColor:o?"success.main":"primary.main",bgcolor:o?"success.50":"primary.50"},children:(0,L.jsxs)(j.A,{sx:{p:3},children:[(0,L.jsxs)(h.A,{direction:"row",justifyContent:"space-between",alignItems:"center",mb:2,children:[(0,L.jsxs)(l.A,{display:"flex",alignItems:"center",gap:1,children:[(0,L.jsx)(T.A,{color:o?"success":"primary"}),(0,L.jsx)(c.A,{variant:"h6",fontWeight:700,children:"Delivery Progress"})]}),o&&(0,L.jsx)(x.A,{icon:(0,L.jsx)(_e.A,{}),label:"Fully Delivered",color:"success",sx:{fontWeight:600}})]}),(0,L.jsxs)(l.A,{sx:{mb:3},children:[(0,L.jsxs)(h.A,{direction:"row",justifyContent:"space-between",mb:1,children:[(0,L.jsxs)(c.A,{variant:"body2",color:"text.secondary",children:[(0,ye.ZV)(t,0)," / ",(0,ye.ZV)(i,0)," kg delivered"]}),(0,L.jsxs)(c.A,{variant:"body2",fontWeight:700,color:"primary.main",children:[a.toFixed(1),"%"]})]}),(0,L.jsx)(je.A,{variant:"determinate",value:a,sx:{height:12,borderRadius:2,backgroundColor:"grey.200","& .MuiLinearProgress-bar":{borderRadius:2,background:o?"linear-gradient(90deg, #4CAF50 0%, #66BB6A 100%)":"linear-gradient(90deg, #2196F3 0%, #42A5F5 100%)"}}})]}),(0,L.jsxs)(p.Ay,{container:!0,spacing:2,children:[(0,L.jsxs)(p.Ay,{item:!0,xs:6,sm:3,children:[(0,L.jsx)(c.A,{variant:"caption",color:"text.secondary",children:"Total Ordered"}),(0,L.jsxs)(c.A,{variant:"h6",fontWeight:600,children:[(0,ye.ZV)(i,0)," kg"]})]}),(0,L.jsxs)(p.Ay,{item:!0,xs:6,sm:3,children:[(0,L.jsx)(c.A,{variant:"caption",color:"text.secondary",children:"Delivered"}),(0,L.jsxs)(c.A,{variant:"h6",fontWeight:600,color:"success.main",children:[(0,ye.ZV)(t,0)," kg"]})]}),(0,L.jsxs)(p.Ay,{item:!0,xs:6,sm:3,children:[(0,L.jsx)(c.A,{variant:"caption",color:"text.secondary",children:"Remaining"}),(0,L.jsxs)(c.A,{variant:"h6",fontWeight:600,color:"error.main",children:[(0,ye.ZV)(s,0)," kg"]})]}),(0,L.jsxs)(p.Ay,{item:!0,xs:6,sm:3,children:[(0,L.jsx)(c.A,{variant:"caption",color:"text.secondary",children:"Delivery Batches"}),(0,L.jsx)(c.A,{variant:"h6",fontWeight:600,children:d})]})]}),m&&!o&&(0,L.jsx)(u.A,{fullWidth:!0,variant:"contained",startIcon:(0,L.jsx)(B.A,{}),onClick:n,sx:{mt:3},size:"large",children:"Create New Delivery Batch"}),o&&(0,L.jsx)(l.A,{sx:{mt:3,p:2,bgcolor:"success.100",borderRadius:2,textAlign:"center"},children:(0,L.jsx)(c.A,{variant:"body2",color:"success.dark",fontWeight:600,children:"\u2713 All deliveries completed successfully!"})})]})})};var pe=n(90837),fe=n(3632),Ce=n(42400);const ke=e=>{let{grns:r,onViewGRN:n,onRecordPayment:i}=e;return r&&0!==r.length?(0,L.jsx)(f.A,{component:_.A,sx:{borderRadius:2,mt:3},children:(0,L.jsxs)(C.A,{children:[(0,L.jsx)(k.A,{children:(0,L.jsxs)(w.A,{sx:{bgcolor:"grey.100"},children:[(0,L.jsx)(S.A,{children:"Delivery #"}),(0,L.jsx)(S.A,{children:"GRN #"}),(0,L.jsx)(S.A,{children:"Delivery Date"}),(0,L.jsx)(S.A,{align:"right",children:"Quantity (kg)"}),(0,L.jsx)(S.A,{children:"Vehicle"}),(0,L.jsx)(S.A,{children:"Driver"}),(0,L.jsx)(S.A,{children:"Invoice #"}),(0,L.jsx)(S.A,{align:"right",children:"Invoice Amount"}),(0,L.jsx)(S.A,{children:"Payment Status"}),(0,L.jsx)(S.A,{align:"center",children:"Actions"})]})}),(0,L.jsx)(W.A,{children:r.map(((e,r)=>{var t;return(0,L.jsxs)(w.A,{hover:!0,children:[(0,L.jsx)(S.A,{children:(0,L.jsx)(x.A,{label:"#".concat(r+1),size:"small",color:"primary",sx:{fontWeight:600}})}),(0,L.jsx)(S.A,{children:(0,L.jsx)(c.A,{variant:"body2",fontWeight:600,children:e.grn_number})}),(0,L.jsx)(S.A,{children:(0,ye.Yq)(e.delivery_date)}),(0,L.jsx)(S.A,{align:"right",children:(0,L.jsx)(c.A,{variant:"body2",fontWeight:600,children:e.net_weight_kg.toLocaleString()})}),(0,L.jsx)(S.A,{children:(0,L.jsx)(c.A,{variant:"body2",children:e.vehicle_number})}),(0,L.jsx)(S.A,{children:(0,L.jsx)(c.A,{variant:"body2",children:e.driver_name})}),(0,L.jsx)(S.A,{children:e.invoice?(0,L.jsxs)(l.A,{display:"flex",alignItems:"center",gap:.5,children:[(0,L.jsx)(pe.A,{sx:{fontSize:16,color:"primary.main"}}),(0,L.jsx)(c.A,{variant:"body2",color:"primary.main",fontWeight:600,children:e.invoice.invoice_number})]}):(0,L.jsx)(x.A,{label:"Generating...",size:"small",color:"warning"})}),(0,L.jsx)(S.A,{align:"right",children:e.invoice?(0,L.jsx)(c.A,{variant:"body2",fontWeight:600,children:(0,ye.vv)(e.invoice.total_amount)}):(0,L.jsx)(c.A,{variant:"body2",color:"text.secondary",children:"-"})}),(0,L.jsx)(S.A,{children:e.invoice?(0,L.jsxs)(h.A,{spacing:.5,children:[(0,L.jsx)(x.A,{label:null===(t=e.invoice.payment_status)||void 0===t?void 0:t.toUpperCase(),size:"small",color:(0,ye.Wm)(e.invoice.payment_status),sx:{fontWeight:600}}),e.invoice.amount_due>0&&(0,L.jsxs)(c.A,{variant:"caption",color:"error.main",fontWeight:500,children:["Due: ",(0,ye.vv)(e.invoice.amount_due)]}),e.invoice.days_overdue&&e.invoice.days_overdue>0&&(0,L.jsxs)(c.A,{variant:"caption",color:"error.main",fontWeight:600,children:[e.invoice.days_overdue," days overdue"]})]}):(0,L.jsx)(c.A,{variant:"caption",color:"text.secondary",children:"Pending"})}),(0,L.jsx)(S.A,{align:"center",children:(0,L.jsxs)(h.A,{direction:"row",spacing:.5,justifyContent:"center",children:[(0,L.jsx)(m.A,{title:"View GRN Details",children:(0,L.jsx)(g.A,{size:"small",onClick:()=>n&&n(e),color:"primary",children:(0,L.jsx)(fe.A,{fontSize:"small"})})}),e.invoice&&e.invoice.amount_due>0&&(0,L.jsx)(m.A,{title:"Record Payment",children:(0,L.jsx)(g.A,{size:"small",color:"success",onClick:()=>i&&e.invoice&&i(e.invoice.id),children:(0,L.jsx)(Ce.A,{fontSize:"small"})})})]})})]},e.id)}))})]})}):(0,L.jsx)(_.A,{sx:{p:8,textAlign:"center",bgcolor:"grey.50",borderRadius:2},children:(0,L.jsx)(c.A,{color:"text.secondary",children:"No delivery batches created yet. Create your first delivery to generate an invoice."})})},we=te.Ik({net_weight_kg:te.ai().required("Net weight is required").min(1,"Must be greater than 0").test("max-remaining","Cannot exceed remaining quantity",(function(e){const{remainingQuantity:r}=this.options.context;return!e||!r||e<=r})),point_of_loading:te.Yj().required("Point of loading is required"),loading_date:te.p6().required("Loading date is required"),delivery_date:te.p6().required("Delivery date is required").min(te.KR("loading_date"),"Delivery date must be after loading date"),delivered_to_name:te.Yj().required("Delivered to name is required"),delivered_to_address:te.Yj().required("Delivery address is required"),delivered_to_contact:te.Yj().required("Contact is required"),vehicle_number:te.Yj().required("Vehicle number is required"),driver_name:te.Yj().required("Driver name is required"),driver_id_number:te.Yj().required("Driver ID is required"),driver_phone:te.Yj().required("Driver phone is required"),gross_weight_kg:te.ai().required("Gross weight is required").min(0,"Must be positive"),tare_weight_kg:te.ai().min(0,"Must be positive"),warehouse_manager_name:te.Yj().required("Warehouse manager name is required"),warehouse_manager_date:te.p6().required("Manager date is required"),received_by_name:te.Yj().required("Received by name is required"),received_by_date:te.p6().required("Received date is required")}),Se=e=>{let{open:r,onClose:n,tradeId:i,tradeNumber:t,remainingQuantityKg:a,onSuccess:o}=e;const[d,h]=(0,s.useState)(!1),x=(0,ie.Wx)({initialValues:{net_weight_kg:a||"",point_of_loading:"",loading_date:"",delivery_date:"",delivered_to_name:"",delivered_to_address:"",delivered_to_contact:"",vehicle_number:"",driver_name:"",driver_id_number:"",driver_phone:"",quantity_bags:"",gross_weight_kg:"",tare_weight_kg:"",warehouse_manager_name:"",warehouse_manager_date:"",received_by_name:"",received_by_date:"",remarks:""},validationSchema:we,validateOnChange:!0,validateOnBlur:!0,onSubmit:async e=>{try{var r;h(!0);const t=await N.O.createDeliveryBatch(i,e);F.oR.success("Delivery batch created! Invoice ".concat((null===(r=t.invoice)||void 0===r?void 0:r.invoice_number)||""," generated.")),o(),n(),x.resetForm()}catch(c){var t,s,a,l,d;const e=(null===c||void 0===c||null===(t=c.response)||void 0===t||null===(s=t.data)||void 0===s?void 0:s.error)||(null===c||void 0===c||null===(a=c.response)||void 0===a||null===(l=a.data)||void 0===l||null===(d=l.net_weight_kg)||void 0===d?void 0:d[0])||"Failed to create delivery batch";F.oR.error(e)}finally{h(!1)}}});(0,s.useEffect)((()=>{const e=parseFloat(x.values.gross_weight_kg)||0,r=parseFloat(x.values.tare_weight_kg)||0;e>0&&r>=0&&x.setFieldValue("net_weight_kg",e-r)}),[x.values.gross_weight_kg,x.values.tare_weight_kg]);const m=()=>{d||(x.resetForm(),n())};return(0,L.jsxs)(X.A,{open:r,onClose:m,maxWidth:"md",fullWidth:!0,children:[(0,L.jsx)(Z.A,{children:(0,L.jsxs)(l.A,{children:[(0,L.jsx)(c.A,{variant:"h6",children:"Create Delivery Batch"}),(0,L.jsx)(c.A,{variant:"body2",color:"text.secondary",children:t})]})}),(0,L.jsxs)("form",{onSubmit:x.handleSubmit,children:[(0,L.jsxs)(K.A,{children:[a&&a>0&&(0,L.jsxs)(A.A,{severity:"info",sx:{mb:3},children:[(0,L.jsxs)(c.A,{variant:"body2",children:[(0,L.jsx)("strong",{children:"Remaining to deliver:"})," ",(0,ye.ZV)(a,0)," kg"]}),(0,L.jsx)(c.A,{variant:"caption",display:"block",color:"text.secondary",children:"This delivery will automatically generate an invoice"})]}),(0,L.jsxs)(p.Ay,{container:!0,spacing:2,children:[(0,L.jsxs)(p.Ay,{item:!0,xs:12,children:[(0,L.jsx)(c.A,{variant:"subtitle2",fontWeight:600,gutterBottom:!0,sx:{mt:1},children:"Loading Details"}),(0,L.jsx)(U.A,{sx:{mb:2}})]}),(0,L.jsx)(p.Ay,{item:!0,xs:12,sm:6,children:(0,L.jsx)(H.A,{fullWidth:!0,label:"Point of Loading *",name:"point_of_loading",value:x.values.point_of_loading,onChange:x.handleChange,error:x.touched.point_of_loading&&Boolean(x.errors.point_of_loading),helperText:x.touched.point_of_loading&&x.errors.point_of_loading})}),(0,L.jsx)(p.Ay,{item:!0,xs:12,sm:6,children:(0,L.jsx)(H.A,{fullWidth:!0,type:"date",label:"Loading Date *",name:"loading_date",value:x.values.loading_date,onChange:x.handleChange,error:x.touched.loading_date&&Boolean(x.errors.loading_date),helperText:x.touched.loading_date&&x.errors.loading_date,InputLabelProps:{shrink:!0}})}),(0,L.jsxs)(p.Ay,{item:!0,xs:12,children:[(0,L.jsx)(c.A,{variant:"subtitle2",fontWeight:600,gutterBottom:!0,sx:{mt:2},children:"Delivery Details"}),(0,L.jsx)(U.A,{sx:{mb:2}})]}),(0,L.jsx)(p.Ay,{item:!0,xs:12,sm:6,children:(0,L.jsx)(H.A,{fullWidth:!0,type:"date",label:"Delivery Date *",name:"delivery_date",value:x.values.delivery_date,onChange:x.handleChange,error:x.touched.delivery_date&&Boolean(x.errors.delivery_date),helperText:x.touched.delivery_date&&x.errors.delivery_date,InputLabelProps:{shrink:!0}})}),(0,L.jsx)(p.Ay,{item:!0,xs:12,sm:6,children:(0,L.jsx)(H.A,{fullWidth:!0,label:"Delivered To Name *",name:"delivered_to_name",value:x.values.delivered_to_name,onChange:x.handleChange,error:x.touched.delivered_to_name&&Boolean(x.errors.delivered_to_name),helperText:x.touched.delivered_to_name&&x.errors.delivered_to_name})}),(0,L.jsx)(p.Ay,{item:!0,xs:12,sm:6,children:(0,L.jsx)(H.A,{fullWidth:!0,multiline:!0,rows:2,label:"Delivery Address *",name:"delivered_to_address",value:x.values.delivered_to_address,onChange:x.handleChange,error:x.touched.delivered_to_address&&Boolean(x.errors.delivered_to_address),helperText:x.touched.delivered_to_address&&x.errors.delivered_to_address})}),(0,L.jsx)(p.Ay,{item:!0,xs:12,sm:6,children:(0,L.jsx)(H.A,{fullWidth:!0,label:"Contact Number *",name:"delivered_to_contact",value:x.values.delivered_to_contact,onChange:x.handleChange,error:x.touched.delivered_to_contact&&Boolean(x.errors.delivered_to_contact),helperText:x.touched.delivered_to_contact&&x.errors.delivered_to_contact})}),(0,L.jsxs)(p.Ay,{item:!0,xs:12,children:[(0,L.jsx)(c.A,{variant:"subtitle2",fontWeight:600,gutterBottom:!0,sx:{mt:2},children:"Vehicle & Driver Information"}),(0,L.jsx)(U.A,{sx:{mb:2}})]}),(0,L.jsx)(p.Ay,{item:!0,xs:12,sm:6,children:(0,L.jsx)(H.A,{fullWidth:!0,label:"Vehicle Number *",name:"vehicle_number",value:x.values.vehicle_number,onChange:x.handleChange,error:x.touched.vehicle_number&&Boolean(x.errors.vehicle_number),helperText:x.touched.vehicle_number&&x.errors.vehicle_number})}),(0,L.jsx)(p.Ay,{item:!0,xs:12,sm:6,children:(0,L.jsx)(H.A,{fullWidth:!0,label:"Driver Name *",name:"driver_name",value:x.values.driver_name,onChange:x.handleChange,error:x.touched.driver_name&&Boolean(x.errors.driver_name),helperText:x.touched.driver_name&&x.errors.driver_name})}),(0,L.jsx)(p.Ay,{item:!0,xs:12,sm:6,children:(0,L.jsx)(H.A,{fullWidth:!0,label:"Driver ID Number *",name:"driver_id_number",value:x.values.driver_id_number,onChange:x.handleChange,error:x.touched.driver_id_number&&Boolean(x.errors.driver_id_number),helperText:x.touched.driver_id_number&&x.errors.driver_id_number})}),(0,L.jsx)(p.Ay,{item:!0,xs:12,sm:6,children:(0,L.jsx)(H.A,{fullWidth:!0,label:"Driver Phone *",name:"driver_phone",value:x.values.driver_phone,onChange:x.handleChange,error:x.touched.driver_phone&&Boolean(x.errors.driver_phone),helperText:x.touched.driver_phone&&x.errors.driver_phone})}),(0,L.jsxs)(p.Ay,{item:!0,xs:12,children:[(0,L.jsx)(c.A,{variant:"subtitle2",fontWeight:600,gutterBottom:!0,sx:{mt:2},children:"Weight Details"}),(0,L.jsx)(U.A,{sx:{mb:2}})]}),(0,L.jsx)(p.Ay,{item:!0,xs:12,sm:4,children:(0,L.jsx)(H.A,{fullWidth:!0,type:"number",label:"Quantity (Bags)",name:"quantity_bags",value:x.values.quantity_bags,onChange:x.handleChange})}),(0,L.jsx)(p.Ay,{item:!0,xs:12,sm:4,children:(0,L.jsx)(H.A,{fullWidth:!0,type:"number",label:"Gross Weight (kg) *",name:"gross_weight_kg",value:x.values.gross_weight_kg,onChange:x.handleChange,error:x.touched.gross_weight_kg&&Boolean(x.errors.gross_weight_kg),helperText:x.touched.gross_weight_kg&&x.errors.gross_weight_kg})}),(0,L.jsx)(p.Ay,{item:!0,xs:12,sm:4,children:(0,L.jsx)(H.A,{fullWidth:!0,type:"number",label:"Tare Weight (kg)",name:"tare_weight_kg",value:x.values.tare_weight_kg,onChange:x.handleChange})}),(0,L.jsx)(p.Ay,{item:!0,xs:12,children:(0,L.jsx)(H.A,{fullWidth:!0,type:"number",label:"Net Weight (kg) *",name:"net_weight_kg",value:x.values.net_weight_kg,onChange:x.handleChange,error:x.touched.net_weight_kg&&Boolean(x.errors.net_weight_kg),helperText:x.touched.net_weight_kg&&x.errors.net_weight_kg,InputProps:{readOnly:!0}})}),(0,L.jsxs)(p.Ay,{item:!0,xs:12,children:[(0,L.jsx)(c.A,{variant:"subtitle2",fontWeight:600,gutterBottom:!0,sx:{mt:2},children:"Sign-off Details"}),(0,L.jsx)(U.A,{sx:{mb:2}})]}),(0,L.jsx)(p.Ay,{item:!0,xs:12,sm:6,children:(0,L.jsx)(H.A,{fullWidth:!0,label:"Warehouse Manager Name *",name:"warehouse_manager_name",value:x.values.warehouse_manager_name,onChange:x.handleChange,error:x.touched.warehouse_manager_name&&Boolean(x.errors.warehouse_manager_name),helperText:x.touched.warehouse_manager_name&&x.errors.warehouse_manager_name})}),(0,L.jsx)(p.Ay,{item:!0,xs:12,sm:6,children:(0,L.jsx)(H.A,{fullWidth:!0,type:"date",label:"Manager Sign Date *",name:"warehouse_manager_date",value:x.values.warehouse_manager_date,onChange:x.handleChange,error:x.touched.warehouse_manager_date&&Boolean(x.errors.warehouse_manager_date),helperText:x.touched.warehouse_manager_date&&x.errors.warehouse_manager_date,InputLabelProps:{shrink:!0}})}),(0,L.jsx)(p.Ay,{item:!0,xs:12,sm:6,children:(0,L.jsx)(H.A,{fullWidth:!0,label:"Received By Name *",name:"received_by_name",value:x.values.received_by_name,onChange:x.handleChange,error:x.touched.received_by_name&&Boolean(x.errors.received_by_name),helperText:x.touched.received_by_name&&x.errors.received_by_name})}),(0,L.jsx)(p.Ay,{item:!0,xs:12,sm:6,children:(0,L.jsx)(H.A,{fullWidth:!0,type:"date",label:"Received Date *",name:"received_by_date",value:x.values.received_by_date,onChange:x.handleChange,error:x.touched.received_by_date&&Boolean(x.errors.received_by_date),helperText:x.touched.received_by_date&&x.errors.received_by_date,InputLabelProps:{shrink:!0}})}),(0,L.jsx)(p.Ay,{item:!0,xs:12,children:(0,L.jsx)(H.A,{fullWidth:!0,multiline:!0,rows:3,label:"Remarks",name:"remarks",value:x.values.remarks,onChange:x.handleChange})})]})]}),(0,L.jsxs)(re.A,{sx:{px:3,pb:3},children:[(0,L.jsx)(u.A,{onClick:m,disabled:d,children:"Cancel"}),(0,L.jsx)(u.A,{type:"submit",variant:"contained",disabled:d,size:"large",children:d?(0,L.jsx)(ne.A,{size:24}):"Create Delivery & Generate Invoice"})]})]})]})};var We=n(53193),Ie=n(51292),qe=n(78492),De=n(14256),Te=n(56629);const Be=e=>{let{open:r,onClose:n,tradeId:i,tradeNumber:t,requiredQuantityKg:a,grainTypeId:o,hubId:d,onSuccess:m}=e;const[g,v]=(0,s.useState)("auto"),[j,y]=(0,s.useState)(!1),[b,p]=(0,s.useState)([]),[I,q]=(0,s.useState)([]),[D,T]=(0,s.useState)(!1);(0,s.useEffect)((()=>{r&&"manual"===g&&B()}),[r,g,o,d]);const B=async()=>{try{T(!0);const e={status:"pending_allocation",page_size:100};o&&(e.grain_type=o),d&&(e.hub=d);const r=await Te.A.get("vouchers/",{params:e});p(r.data.results||[])}catch(e){console.error("Failed to load vouchers:",e),F.oR.error("Failed to load available vouchers")}finally{T(!1)}},R=e=>{q((r=>r.includes(e)?r.filter((r=>r!==e)):[...r,e]))},N=()=>I.reduce(((e,r)=>{const n=b.find((e=>e.id===r));return e+((null===n||void 0===n?void 0:n.quantity_kg)||0)}),0),V=N(),z=V>=a;return(0,L.jsxs)(X.A,{open:r,onClose:n,maxWidth:"md",fullWidth:!0,children:[(0,L.jsx)(Z.A,{children:(0,L.jsxs)(l.A,{children:[(0,L.jsx)(c.A,{variant:"h6",children:"Allocate Vouchers to Trade"}),(0,L.jsx)(c.A,{variant:"body2",color:"text.secondary",children:t})]})}),(0,L.jsxs)(K.A,{children:[(0,L.jsxs)(A.A,{severity:"info",sx:{mb:3},children:[(0,L.jsxs)(c.A,{variant:"body2",fontWeight:600,children:["Required Quantity: ",a.toLocaleString()," kg"]}),"manual"===g&&I.length>0&&(0,L.jsxs)(c.A,{variant:"body2",sx:{mt:1},children:["Selected Quantity: ",V.toLocaleString()," kg"]})]}),(0,L.jsxs)(We.A,{component:"fieldset",sx:{mb:3},children:[(0,L.jsx)(Ie.A,{component:"legend",children:"Allocation Method"}),(0,L.jsxs)(qe.A,{value:g,onChange:e=>v(e.target.value),children:[(0,L.jsx)($.A,{value:"auto",control:(0,L.jsx)(De.A,{}),label:(0,L.jsxs)(l.A,{children:[(0,L.jsx)(c.A,{variant:"body2",fontWeight:600,children:"Automatic Allocation"}),(0,L.jsx)(c.A,{variant:"caption",color:"text.secondary",children:"System will automatically select vouchers from available inventory"})]})}),(0,L.jsx)($.A,{value:"manual",control:(0,L.jsx)(De.A,{}),label:(0,L.jsxs)(l.A,{children:[(0,L.jsx)(c.A,{variant:"body2",fontWeight:600,children:"Manual Selection"}),(0,L.jsx)(c.A,{variant:"caption",color:"text.secondary",children:"Manually select specific vouchers to allocate"})]})})]})]}),"manual"===g&&(0,L.jsx)(L.Fragment,{children:D?(0,L.jsx)(l.A,{display:"flex",justifyContent:"center",py:4,children:(0,L.jsx)(ne.A,{})}):0===b.length?(0,L.jsx)(A.A,{severity:"warning",children:(0,L.jsx)(c.A,{variant:"body2",children:"No vouchers available for allocation. Check that vouchers exist with status 'pending_allocation' for this grain type and hub."})}):(0,L.jsxs)(L.Fragment,{children:[(0,L.jsxs)(h.A,{direction:"row",justifyContent:"space-between",alignItems:"center",mb:2,children:[(0,L.jsxs)(c.A,{variant:"subtitle2",children:["Available Vouchers (",b.length,")"]}),I.length>0&&(0,L.jsx)(x.A,{label:"".concat(I.length," selected"),color:z?"success":"warning",size:"small"})]}),(0,L.jsx)(f.A,{component:_.A,sx:{maxHeight:400},children:(0,L.jsxs)(C.A,{stickyHeader:!0,size:"small",children:[(0,L.jsx)(k.A,{children:(0,L.jsxs)(w.A,{children:[(0,L.jsx)(S.A,{padding:"checkbox"}),(0,L.jsx)(S.A,{children:"Voucher #"}),(0,L.jsx)(S.A,{children:"Farmer"}),(0,L.jsx)(S.A,{children:"Grain Type"}),(0,L.jsx)(S.A,{align:"right",children:"Quantity (kg)"})]})}),(0,L.jsx)(W.A,{children:b.map((e=>(0,L.jsxs)(w.A,{hover:!0,selected:I.includes(e.id),onClick:()=>R(e.id),sx:{cursor:"pointer"},children:[(0,L.jsx)(S.A,{padding:"checkbox",children:(0,L.jsx)(ee.A,{checked:I.includes(e.id),onChange:()=>R(e.id)})}),(0,L.jsx)(S.A,{children:(0,L.jsx)(c.A,{variant:"body2",fontWeight:600,children:e.voucher_number})}),(0,L.jsx)(S.A,{children:(0,L.jsx)(c.A,{variant:"body2",children:e.farmer_name})}),(0,L.jsx)(S.A,{children:(0,L.jsx)(c.A,{variant:"body2",children:e.grain_type_name})}),(0,L.jsx)(S.A,{align:"right",children:(0,L.jsx)(c.A,{variant:"body2",fontWeight:600,children:e.quantity_kg.toLocaleString()})})]},e.id)))})]})}),!z&&I.length>0&&(0,L.jsx)(A.A,{severity:"warning",sx:{mt:2},children:(0,L.jsxs)(c.A,{variant:"body2",children:["Selected quantity (",V.toLocaleString()," kg) is less than required (",a.toLocaleString()," kg). Please select more vouchers."]})})]})})]}),(0,L.jsxs)(re.A,{sx:{px:3,pb:3},children:[(0,L.jsx)(u.A,{onClick:n,disabled:j,children:"Cancel"}),(0,L.jsx)(u.A,{onClick:async()=>{const e={allocation_type:g};if("manual"===g){if(0===I.length)return void F.oR.error("Please select at least one voucher");const r=N();if(r<a)return void F.oR.error("Selected quantity (".concat(r.toLocaleString()," kg) is less than required (").concat(a.toLocaleString()," kg)"));e.voucher_ids=I}y(!0),m(e)},variant:"contained",disabled:j||"manual"===g&&(0===I.length||!z),children:j?(0,L.jsx)(ne.A,{size:24}):"Allocate Vouchers"})]})]})},Re=["children","value","index"];function Fe(e){const{children:r,value:n,index:s}=e,a=(0,t.A)(e,Re);return(0,L.jsx)("div",(0,i.A)((0,i.A)({hidden:n!==s},a),{},{children:n===s&&(0,L.jsx)(l.A,{children:r})}))}const Ne=()=>{var e,r,n,i,t,V,z,P,G;const{tradeId:O}=(0,a.g)(),M=(0,a.Zp)(),U=(0,a.zy)(),X=(0,o.A)(),Z=(0,d.A)(X.breakpoints.down("md")),[K,H]=(0,s.useState)(null),[J,$]=(0,s.useState)(!0),[ee,re]=(0,s.useState)((()=>{const e=new URLSearchParams(U.search).get("tab");return"delivery"===e?7:"vouchers"===e?8:0})()),[ne,ie]=(0,s.useState)(!1),[te,se]=(0,s.useState)(null),[ae,oe]=(0,s.useState)(!1),[de,ce]=(0,s.useState)(!1),[ue,me]=(0,s.useState)(!1),[je,_e]=(0,s.useState)(!1),[pe,fe]=(0,s.useState)(!1),[Ce,we]=(0,s.useState)(!1),[We,Ie]=(0,s.useState)(null),[qe,De]=(0,s.useState)(null),[Te,Re]=(0,s.useState)(!1);(0,Ae.A)(K?"Trade ".concat(K.trade_number):"Trade Details"),(0,s.useEffect)((()=>{O&&Ne()}),[O]);const Ne=async()=>{try{$(!0);const e=await N.O.getTradeDetails(O);H(e)}catch(n){var e,r;F.oR.error((null===n||void 0===n||null===(e=n.response)||void 0===e||null===(r=e.data)||void 0===r?void 0:r.error)||"Failed to load trade"),M("/admin/trade")}finally{$(!1)}},Ve=async()=>{try{const e=await N.O.getDeliveryProgress(O);se(e)}catch(e){console.error("Failed to load delivery progress:",e)}};(0,s.useEffect)((()=>{O&&K&&["ready_for_delivery","in_transit","delivered"].includes(K.status)&&Ve()}),[O,null===K||void 0===K?void 0:K.status]);const ze=e=>new Intl.NumberFormat("en-UG",{style:"currency",currency:"UGX",minimumFractionDigits:0}).format(e);if(J)return(0,L.jsx)(l.A,{display:"flex",justifyContent:"center",alignItems:"center",minHeight:"70vh",children:(0,L.jsx)(E.A,{})});if(!K)return(0,L.jsx)(l.A,{p:3,children:(0,L.jsx)(c.A,{children:"Trade not found"})});const Pe=K.requires_voucher_allocation&&!K.allocation_complete;(0,ye.zD)(K);return(0,L.jsxs)(l.A,{sx:{p:{xs:2,sm:3,md:4},maxWidth:"lg",mx:"auto"},children:[(0,L.jsxs)(h.A,{direction:{xs:"column",sm:"row"},justifyContent:"space-between",alignItems:{xs:"stretch",sm:"center"},spacing:2,mb:4,children:[(0,L.jsxs)(h.A,{direction:"row",alignItems:"center",spacing:2,children:[(0,L.jsx)(u.A,{startIcon:(0,L.jsx)(I.A,{}),onClick:()=>M("/admin/trade"),variant:"outlined",size:Z?"small":"medium",children:"Back"}),(0,L.jsxs)(l.A,{children:[(0,L.jsx)(c.A,{variant:Z?"h5":"h4",fontWeight:700,children:K.trade_number}),(0,L.jsxs)(c.A,{variant:"body2",color:"text.secondary",children:["Created ",new Date(K.created_at).toLocaleDateString()]})]})]}),(0,L.jsxs)(h.A,{direction:"row",spacing:1,flexWrap:"wrap",gap:1,children:[(0,L.jsx)(x.A,{label:K.status_display,color:"primary"}),Pe&&(0,L.jsx)(u.A,{variant:"outlined",color:"warning",startIcon:(0,L.jsx)(q.A,{}),onClick:()=>we(!0),size:"small",children:"Allocate Vouchers"}),"draft"===K.status&&(0,L.jsx)(m.A,{title:"Edit Trade",children:(0,L.jsx)(g.A,{onClick:()=>Re(!0),color:"primary",children:(0,L.jsx)(D.A,{})})}),"completed"!==K.status&&"cancelled"!==K.status&&(0,L.jsx)(u.A,{variant:"contained",startIcon:(0,L.jsx)(T.A,{}),onClick:async()=>{try{await N.O.progressStatus(O,{notes:"Progressed from details page"}),F.oR.success("Status progressed successfully"),Ne()}catch(n){var e,r;F.oR.error((null===n||void 0===n||null===(e=n.response)||void 0===e||null===(r=e.data)||void 0===r?void 0:r.error)||"Failed to progress status")}},size:"small",children:"Progress"})]})]}),(Pe||K.requires_financing&&!K.financing_complete)&&(0,L.jsxs)(A.A,{severity:"warning",sx:{mb:3},children:[(0,L.jsx)(c.A,{variant:"subtitle2",fontWeight:600,children:"Action Required:"}),(0,L.jsxs)("ul",{style:{margin:"8px 0",paddingLeft:20},children:[Pe&&(0,L.jsx)("li",{children:(0,L.jsx)(c.A,{variant:"body2",children:"Allocate vouchers before progressing to delivery"})}),K.requires_financing&&!K.financing_complete&&(0,L.jsx)("li",{children:(0,L.jsx)(c.A,{variant:"body2",children:"Complete investor financing allocation"})})]})]}),(0,L.jsx)(v.A,{sx:{mb:4,borderRadius:2,overflow:"hidden"},children:(0,L.jsx)(j.A,{sx:{py:5},children:(0,L.jsx)(Y,{currentStatus:K.status})})}),(0,L.jsxs)(_.A,{elevation:3,sx:{borderRadius:2,overflow:"hidden"},children:[(0,L.jsxs)(y.A,{value:ee,onChange:(e,r)=>re(r),variant:Z?"scrollable":"standard",scrollButtons:"auto",sx:{borderBottom:1,borderColor:"divider",px:{xs:2,sm:3},pt:1},children:[(0,L.jsx)(b.A,{label:"Overview"}),(0,L.jsx)(b.A,{label:"Cost Breakdown"}),(0,L.jsx)(b.A,{label:"Costs"}),(0,L.jsx)(b.A,{label:"Brokerages"}),(0,L.jsx)(b.A,{label:"Financing"}),(0,L.jsx)(b.A,{label:"Loans"}),(0,L.jsx)(b.A,{label:"Invoices"}),(0,L.jsx)(b.A,{label:"Delivery & GRN"}),K.requires_voucher_allocation&&(0,L.jsx)(b.A,{label:"Voucher Allocation"})]}),(0,L.jsxs)(l.A,{sx:{p:{xs:2,sm:3,md:4}},children:[(0,L.jsx)(Fe,{value:ee,index:0,children:(0,L.jsxs)(p.Ay,{container:!0,spacing:4,children:[(0,L.jsxs)(p.Ay,{item:!0,xs:12,md:6,children:[(0,L.jsx)(c.A,{variant:"h6",gutterBottom:!0,fontWeight:600,children:"Parties"}),(0,L.jsx)(p.Ay,{container:!0,spacing:2,children:[{label:"Buyer",value:null===(e=K.buyer)||void 0===e?void 0:e.name},{label:"Supplier",value:"".concat(null===(r=K.supplier)||void 0===r?void 0:r.first_name," ").concat(null===(n=K.supplier)||void 0===n?void 0:n.last_name)},{label:"Hub",value:null===(i=K.hub)||void 0===i?void 0:i.name},{label:"Grain & Grade",value:"".concat(null===(t=K.grain_type)||void 0===t?void 0:t.name," \u2013 ").concat(null===(V=K.quality_grade)||void 0===V?void 0:V.name)}].map((e=>(0,L.jsxs)(p.Ay,{item:!0,xs:12,sm:6,children:[(0,L.jsx)(c.A,{variant:"body2",color:"text.secondary",children:e.label}),(0,L.jsx)(c.A,{variant:"body1",fontWeight:600,children:e.value||"N/A"})]},e.label)))})]}),(0,L.jsxs)(p.Ay,{item:!0,xs:12,md:6,children:[(0,L.jsx)(c.A,{variant:"h6",gutterBottom:!0,fontWeight:600,children:"Quantities"}),(0,L.jsx)(p.Ay,{container:!0,spacing:2,children:[{label:"Gross Tonnage",value:"".concat((K.gross_tonnage/1e3).toFixed(2)," MT")},{label:"Net Tonnage",value:"".concat((K.net_tonnage/1e3).toFixed(2)," MT")},{label:"Quantity (kg)",value:K.quantity_kg.toLocaleString()+" kg"},{label:"Bags",value:K.quantity_bags||"N/A"}].map((e=>(0,L.jsxs)(p.Ay,{item:!0,xs:12,sm:6,children:[(0,L.jsx)(c.A,{variant:"body2",color:"text.secondary",children:e.label}),(0,L.jsx)(c.A,{variant:"body1",fontWeight:600,children:e.value})]},e.label)))})]}),(0,L.jsxs)(p.Ay,{item:!0,xs:12,children:[(0,L.jsx)(c.A,{variant:"h6",gutterBottom:!0,fontWeight:600,children:"Financial Summary"}),(0,L.jsx)(p.Ay,{container:!0,spacing:2,children:[{label:"Buying Price",value:"".concat(ze(K.buying_price),"/kg"),color:"error.main"},{label:"Selling Price",value:"".concat(ze(K.selling_price),"/kg"),color:"success.main"},{label:"Total Cost",value:ze(K.total_trade_cost)},{label:"Revenue",value:ze(K.payable_by_buyer)},{label:"Margin",value:ze(K.margin),bold:!0,color:"primary.main"},{label:"ROI",value:"".concat(K.roi_percentage.toFixed(2),"%"),bold:!0,color:"success.main"}].map((e=>(0,L.jsx)(p.Ay,{item:!0,xs:6,sm:4,md:2,children:(0,L.jsxs)(_.A,{sx:{p:2,bgcolor:"background.default",borderRadius:2,height:"100%"},children:[(0,L.jsx)(c.A,{variant:"body2",color:"text.secondary",gutterBottom:!0,children:e.label}),(0,L.jsx)(c.A,{variant:"h6",fontWeight:e.bold?700:600,color:e.color,children:e.value})]})},e.label)))})]}),(null===(z=K.loss_summary)||void 0===z?void 0:z.has_loss)&&(0,L.jsx)(p.Ay,{item:!0,xs:12,children:(0,L.jsxs)(A.A,{severity:"warning",sx:{mt:2},children:[(0,L.jsx)(c.A,{variant:"subtitle2",fontWeight:600,children:"Loss Detected"}),(0,L.jsxs)(c.A,{children:["Quantity Lost: ",K.loss_summary.quantity_kg.toFixed(2)," kg (",K.loss_summary.percentage.toFixed(2),"%)"]}),(0,L.jsxs)(c.A,{children:["Cost of Loss: ",ze(K.loss_summary.cost)]}),K.loss_summary.reason&&(0,L.jsxs)(c.A,{children:["Reason: ",K.loss_summary.reason]})]})})]})}),(0,L.jsx)(Fe,{value:ee,index:1,children:(0,L.jsx)(Q,{tradeId:K.id})}),(0,L.jsxs)(Fe,{value:ee,index:2,children:[(0,L.jsxs)(h.A,{direction:"row",justifyContent:"space-between",alignItems:"center",mb:3,children:[(0,L.jsx)(c.A,{variant:"h6",children:"Additional Costs"}),(0,L.jsx)(u.A,{variant:"contained",startIcon:(0,L.jsx)(B.A,{}),onClick:()=>{Ie(null),oe(!0)},children:"Add Cost"})]}),K.additional_costs&&K.additional_costs.length>0?(0,L.jsx)(f.A,{component:_.A,sx:{border:1,borderColor:"divider"},children:(0,L.jsxs)(C.A,{children:[(0,L.jsx)(k.A,{children:(0,L.jsxs)(w.A,{children:[(0,L.jsx)(S.A,{children:"Cost Type"}),(0,L.jsx)(S.A,{children:"Description"}),(0,L.jsx)(S.A,{align:"right",children:"Amount"}),(0,L.jsx)(S.A,{align:"center",children:"Per Unit"}),(0,L.jsx)(S.A,{align:"right",children:"Total"}),(0,L.jsx)(S.A,{align:"center",children:"Actions"})]})}),(0,L.jsx)(W.A,{children:K.additional_costs.map((e=>(0,L.jsxs)(w.A,{children:[(0,L.jsx)(S.A,{children:e.cost_type}),(0,L.jsx)(S.A,{children:e.description||"-"}),(0,L.jsx)(S.A,{align:"right",children:ze(e.amount)}),(0,L.jsx)(S.A,{align:"center",children:e.is_per_unit?"Yes":"No"}),(0,L.jsx)(S.A,{align:"right",children:ze(e.total_amount||e.amount)}),(0,L.jsxs)(S.A,{align:"center",children:[(0,L.jsx)(g.A,{size:"small",onClick:()=>{Ie(e),oe(!0)},children:(0,L.jsx)(D.A,{fontSize:"small"})}),(0,L.jsx)(g.A,{size:"small",color:"error",onClick:()=>(async e=>{if(window.confirm("Are you sure you want to delete this cost?"))try{await N.O.deleteTradeCost(e),F.oR.success("Cost deleted successfully"),Ne()}catch(r){F.oR.error("Failed to delete cost")}})(e.id),children:(0,L.jsx)(R.A,{fontSize:"small"})})]})]},e.id)))})]})}):(0,L.jsx)(_.A,{sx:{p:8,textAlign:"center",bgcolor:"grey.50",borderRadius:2},children:(0,L.jsx)(c.A,{color:"text.secondary",children:"No additional costs added yet"})})]}),(0,L.jsxs)(Fe,{value:ee,index:3,children:[(0,L.jsxs)(h.A,{direction:"row",justifyContent:"space-between",alignItems:"center",mb:3,children:[(0,L.jsx)(c.A,{variant:"h6",children:"Brokerages"}),(0,L.jsx)(u.A,{variant:"contained",startIcon:(0,L.jsx)(B.A,{}),onClick:()=>{De(null),ce(!0)},children:"Add Brokerage"})]}),K.brokerages&&K.brokerages.length>0?(0,L.jsx)(f.A,{component:_.A,sx:{border:1,borderColor:"divider"},children:(0,L.jsxs)(C.A,{children:[(0,L.jsx)(k.A,{children:(0,L.jsxs)(w.A,{children:[(0,L.jsx)(S.A,{children:"Agent"}),(0,L.jsx)(S.A,{children:"Type"}),(0,L.jsx)(S.A,{align:"right",children:"Commission Value"}),(0,L.jsx)(S.A,{align:"right",children:"Amount"}),(0,L.jsx)(S.A,{children:"Notes"}),(0,L.jsx)(S.A,{align:"center",children:"Actions"})]})}),(0,L.jsx)(W.A,{children:K.brokerages.map((e=>(0,L.jsxs)(w.A,{children:[(0,L.jsx)(S.A,{children:e.agent?"".concat(e.agent.first_name," ").concat(e.agent.last_name):"N/A"}),(0,L.jsx)(S.A,{children:e.commission_type}),(0,L.jsx)(S.A,{align:"right",children:e.commission_value}),(0,L.jsx)(S.A,{align:"right",children:ze(e.amount)}),(0,L.jsx)(S.A,{children:e.notes||"-"}),(0,L.jsxs)(S.A,{align:"center",children:[(0,L.jsx)(g.A,{size:"small",onClick:()=>{De(e),ce(!0)},children:(0,L.jsx)(D.A,{fontSize:"small"})}),(0,L.jsx)(g.A,{size:"small",color:"error",onClick:()=>(async e=>{if(window.confirm("Are you sure you want to delete this brokerage?"))try{await N.O.deleteBrokerage(e),F.oR.success("Brokerage deleted successfully"),Ne()}catch(r){F.oR.error("Failed to delete brokerage")}})(e.id),children:(0,L.jsx)(R.A,{fontSize:"small"})})]})]},e.id)))})]})}):(0,L.jsx)(_.A,{sx:{p:8,textAlign:"center",bgcolor:"grey.50",borderRadius:2},children:(0,L.jsx)(c.A,{color:"text.secondary",children:"No brokerages added"})})]}),(0,L.jsxs)(Fe,{value:ee,index:4,children:[(0,L.jsxs)(h.A,{direction:"row",justifyContent:"space-between",alignItems:"center",mb:3,children:[(0,L.jsxs)(l.A,{children:[(0,L.jsx)(c.A,{variant:"h6",children:"Investor Financing"}),(0,L.jsxs)(c.A,{variant:"body2",color:"text.secondary",children:["Total Allocated: ",ze(K.total_financing_allocated||0)]})]}),K.requires_financing&&!K.financing_complete&&(0,L.jsx)(u.A,{variant:"contained",startIcon:(0,L.jsx)(B.A,{}),onClick:()=>me(!0),children:"Add Financing"})]}),K.financing_allocations&&K.financing_allocations.length>0?(0,L.jsx)(f.A,{component:_.A,sx:{border:1,borderColor:"divider"},children:(0,L.jsxs)(C.A,{children:[(0,L.jsx)(k.A,{children:(0,L.jsxs)(w.A,{children:[(0,L.jsx)(S.A,{children:"Investor"}),(0,L.jsx)(S.A,{align:"right",children:"Amount"}),(0,L.jsx)(S.A,{align:"right",children:"Percentage"}),(0,L.jsx)(S.A,{align:"right",children:"Margin Earned"}),(0,L.jsx)(S.A,{align:"right",children:"Investor Share"}),(0,L.jsx)(S.A,{children:"Date"})]})}),(0,L.jsx)(W.A,{children:K.financing_allocations.map((e=>(0,L.jsxs)(w.A,{children:[(0,L.jsx)(S.A,{children:e.investor?"".concat(e.investor.first_name," ").concat(e.investor.last_name):"N/A"}),(0,L.jsx)(S.A,{align:"right",children:ze(e.allocated_amount)}),(0,L.jsxs)(S.A,{align:"right",children:[e.allocation_percentage.toFixed(2),"%"]}),(0,L.jsx)(S.A,{align:"right",children:ze(e.margin_earned)}),(0,L.jsx)(S.A,{align:"right",children:ze(e.investor_margin)}),(0,L.jsx)(S.A,{children:new Date(e.allocation_date).toLocaleDateString()})]},e.id)))})]})}):(0,L.jsx)(_.A,{sx:{p:8,textAlign:"center",bgcolor:"grey.50",borderRadius:2},children:(0,L.jsx)(c.A,{color:"text.secondary",children:K.requires_financing?"No financing allocated yet":"This trade does not require investor financing"})})]}),(0,L.jsxs)(Fe,{value:ee,index:5,children:[(0,L.jsxs)(h.A,{direction:"row",justifyContent:"space-between",alignItems:"center",mb:3,children:[(0,L.jsxs)(l.A,{children:[(0,L.jsx)(c.A,{variant:"h6",children:"Trade Loans"}),(0,L.jsxs)(c.A,{variant:"body2",color:"text.secondary",children:["Total Loans: ",ze(K.total_loans||0)]})]}),(0,L.jsx)(u.A,{variant:"contained",startIcon:(0,L.jsx)(B.A,{}),onClick:()=>_e(!0),children:"Add Loan"})]}),K.loans&&K.loans.length>0?(0,L.jsx)(f.A,{component:_.A,sx:{border:1,borderColor:"divider"},children:(0,L.jsxs)(C.A,{children:[(0,L.jsx)(k.A,{children:(0,L.jsxs)(w.A,{children:[(0,L.jsx)(S.A,{children:"Investor"}),(0,L.jsx)(S.A,{align:"right",children:"Amount"}),(0,L.jsx)(S.A,{align:"right",children:"Interest Rate"}),(0,L.jsx)(S.A,{children:"Due Date"}),(0,L.jsx)(S.A,{align:"right",children:"Total Due"}),(0,L.jsx)(S.A,{align:"right",children:"Outstanding"}),(0,L.jsx)(S.A,{children:"Status"})]})}),(0,L.jsx)(W.A,{children:K.loans.map((e=>(0,L.jsxs)(w.A,{children:[(0,L.jsx)(S.A,{children:e.investor?"".concat(e.investor.first_name," ").concat(e.investor.last_name):"N/A"}),(0,L.jsx)(S.A,{align:"right",children:ze(e.amount)}),(0,L.jsxs)(S.A,{align:"right",children:[e.interest_rate,"%"]}),(0,L.jsx)(S.A,{children:new Date(e.due_date).toLocaleDateString()}),(0,L.jsx)(S.A,{align:"right",children:ze(e.total_due||0)}),(0,L.jsx)(S.A,{align:"right",children:ze(e.outstanding_balance||0)}),(0,L.jsx)(S.A,{children:(0,L.jsx)(x.A,{label:e.status,size:"small",color:"repaid"===e.status?"success":"active"===e.status?"primary":"default"})})]},e.id)))})]})}):(0,L.jsx)(_.A,{sx:{p:8,textAlign:"center",bgcolor:"grey.50",borderRadius:2},children:(0,L.jsx)(c.A,{color:"text.secondary",children:"No loans for this trade"})})]}),(0,L.jsx)(Fe,{value:ee,index:6,children:K.invoices_list&&K.invoices_list.length>0?(0,L.jsx)(p.Ay,{container:!0,spacing:3,children:K.invoices_list.map((e=>(0,L.jsx)(p.Ay,{item:!0,xs:12,md:6,children:(0,L.jsx)(_.A,{sx:{p:3,height:"100%"},children:(0,L.jsxs)(h.A,{direction:"row",justifyContent:"space-between",alignItems:"flex-start",children:[(0,L.jsxs)(l.A,{children:[(0,L.jsx)(c.A,{variant:"subtitle1",fontWeight:600,children:e.invoice_number}),e.grn_number&&(0,L.jsxs)(c.A,{variant:"body2",color:"text.secondary",children:["GRN: ",e.grn_number]}),(0,L.jsxs)(c.A,{variant:"body2",children:["Amount: ",ze(e.total_amount)]}),(0,L.jsxs)(c.A,{variant:"body2",color:"error.main",children:["Due: ",ze(e.amount_due)]})]}),(0,L.jsx)(x.A,{label:e.status,size:"small"})]})})},e.id)))}):(0,L.jsxs)(_.A,{sx:{p:8,textAlign:"center",bgcolor:"grey.50",borderRadius:2},children:[(0,L.jsx)(c.A,{color:"text.secondary",gutterBottom:!0,children:"No invoices generated yet"}),"delivered"===K.status&&(0,L.jsx)(c.A,{variant:"body2",color:"text.secondary",children:"Create a GRN to automatically generate an invoice"})]})}),(0,L.jsxs)(Fe,{value:ee,index:7,children:[(0,L.jsx)(c.A,{variant:"h6",fontWeight:600,mb:3,children:"Delivery Management"}),["ready_for_delivery","in_transit","delivered","completed"].includes(K.status)?(0,L.jsxs)(L.Fragment,{children:[(null===te||void 0===te?void 0:te.delivery_summary)&&(0,L.jsx)(be,{deliverySummary:te.delivery_summary,onCreateDelivery:()=>ie(!0)}),(null===te||void 0===te?void 0:te.next_steps)&&te.next_steps.length>0&&(0,L.jsxs)(A.A,{severity:"info",sx:{mb:3},children:[(0,L.jsx)(c.A,{variant:"subtitle2",fontWeight:600,gutterBottom:!0,children:"Next Steps:"}),(0,L.jsx)("ul",{style:{margin:0,paddingLeft:20},children:te.next_steps.map(((e,r)=>(0,L.jsx)("li",{children:(0,L.jsx)(c.A,{variant:"body2",children:e})},r)))})]}),K.grns&&K.grns.length>0?(0,L.jsx)(ke,{grns:K.grns,onViewGRN:e=>console.log("View GRN:",e),onRecordPayment:e=>console.log("Record payment:",e)}):(0,L.jsxs)(_.A,{sx:{p:8,textAlign:"center",bgcolor:"grey.50",borderRadius:2},children:[(0,L.jsx)(c.A,{color:"text.secondary",gutterBottom:!0,children:"No delivery batches created yet"}),(0,L.jsx)(c.A,{variant:"body2",color:"text.secondary",children:'Click "Create New Delivery Batch" above to start deliveries'})]})]}):(0,L.jsxs)(A.A,{severity:"info",children:[(0,L.jsx)(c.A,{variant:"body2",children:"Delivery management will be available when trade reaches 'ready_for_delivery' status."}),(0,L.jsxs)(c.A,{variant:"body2",fontWeight:600,sx:{mt:1},children:["Current status: ",K.status_display]}),(0,L.jsx)(c.A,{variant:"caption",display:"block",color:"text.secondary",sx:{mt:1},children:(0,ye.fY)(K)})]})]}),K.requires_voucher_allocation&&(0,L.jsxs)(Fe,{value:ee,index:8,children:[(0,L.jsx)(c.A,{variant:"h6",fontWeight:600,mb:3,children:"Voucher Allocation"}),K.allocation_complete?(0,L.jsxs)(A.A,{severity:"success",sx:{mb:3},children:[(0,L.jsx)(c.A,{variant:"body2",fontWeight:600,children:"\u2713 Vouchers allocated successfully"}),(0,L.jsxs)(c.A,{variant:"body2",children:[K.vouchers_count," voucher(s) allocated for this trade"]})]}):(0,L.jsxs)(A.A,{severity:"warning",sx:{mb:3},children:[(0,L.jsx)(c.A,{variant:"body2",fontWeight:600,children:"Voucher allocation required"}),(0,L.jsx)(c.A,{variant:"body2",children:"This trade requires voucher allocation before delivery can begin."}),(0,L.jsx)(u.A,{variant:"contained",startIcon:(0,L.jsx)(q.A,{}),onClick:()=>we(!0),sx:{mt:2},children:"Allocate Vouchers Now"})]}),K.vouchers_detail&&K.vouchers_detail.length>0&&(0,L.jsx)(f.A,{component:_.A,sx:{mt:3},children:(0,L.jsxs)(C.A,{children:[(0,L.jsx)(k.A,{children:(0,L.jsxs)(w.A,{children:[(0,L.jsx)(S.A,{children:"Voucher Number"}),(0,L.jsx)(S.A,{children:"Farmer"}),(0,L.jsx)(S.A,{align:"right",children:"Quantity (kg)"}),(0,L.jsx)(S.A,{children:"Status"})]})}),(0,L.jsx)(W.A,{children:K.vouchers_detail.map((e=>{var r;return(0,L.jsxs)(w.A,{children:[(0,L.jsx)(S.A,{children:e.voucher_number}),(0,L.jsx)(S.A,{children:e.farmer_name}),(0,L.jsx)(S.A,{align:"right",children:null===(r=e.quantity_kg)||void 0===r?void 0:r.toLocaleString()}),(0,L.jsx)(S.A,{children:(0,L.jsx)(x.A,{label:e.status,size:"small"})})]},e.id)}))})]})})]})]})]}),(0,L.jsx)(le,{open:ae,onClose:()=>{oe(!1),Ie(null)},tradeId:K.id,onSuccess:Ne,initialValues:We}),(0,L.jsx)(he,{open:de,onClose:()=>{ce(!1),De(null)},tradeId:K.id,onSuccess:Ne,initialValues:qe}),(0,L.jsx)(xe,{open:ue,onClose:()=>me(!1),tradeId:K.id,onSuccess:Ne,tradeDetails:K}),(0,L.jsx)(ge,{open:je,onClose:()=>_e(!1),tradeId:K.id,onSuccess:Ne}),(0,L.jsx)(Se,{open:ne,onClose:()=>ie(!1),tradeId:K.id,tradeNumber:K.trade_number,remainingQuantityKg:K.remaining_quantity_kg,onSuccess:()=>{Ne(),Ve()}}),K.requires_voucher_allocation&&(0,L.jsx)(Be,{open:Ce,onClose:()=>we(!1),tradeId:K.id,tradeNumber:K.trade_number,requiredQuantityKg:K.quantity_kg,grainTypeId:null===(P=K.grain_type)||void 0===P?void 0:P.id,hubId:null===(G=K.hub)||void 0===G?void 0:G.id,onSuccess:async e=>{try{await N.O.allocateVouchers(O,e),F.oR.success("Vouchers allocated successfully"),Ne(),we(!1)}catch(i){var r,n;F.oR.error((null===i||void 0===i||null===(r=i.response)||void 0===r||null===(n=r.data)||void 0===n?void 0:n.error)||"Failed to allocate vouchers")}}}),Te&&(0,L.jsx)(ve.A,{callBack:Ne,formType:"Update",handleClose:()=>Re(!1),initialValues:K})]})}}}]);
//# sourceMappingURL=1220.8c449475.chunk.js.map